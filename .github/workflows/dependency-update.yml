name: Dependency Update

on:
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

env:
  NODE_VERSION: '25'

jobs:
  update-dependencies:
    name: Update Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Check for updates
        id: updates
        run: |
          echo "## Checking for dependency updates..." >> $GITHUB_STEP_SUMMARY

          # Check outdated packages
          npm outdated --json > outdated.json || true

          # Count updates available
          if [ -s outdated.json ] && [ "$(cat outdated.json)" != "{}" ]; then
            echo "updates_available=true" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Outdated packages found:" >> $GITHUB_STEP_SUMMARY
            cat outdated.json | jq -r 'to_entries[] | "- \(.key): \(.value.current) -> \(.value.latest)"' >> $GITHUB_STEP_SUMMARY
          else
            echo "updates_available=false" >> $GITHUB_OUTPUT
            echo "All dependencies are up to date!" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Update dependencies
        if: steps.updates.outputs.updates_available == 'true'
        run: |
          # Update patch and minor versions (safer)
          npm update

          # Update lock file
          npm install

      - name: Generate Prisma Client
        if: steps.updates.outputs.updates_available == 'true'
        run: npm run prisma:generate

      - name: Run lint after update
        if: steps.updates.outputs.updates_available == 'true'
        run: npm run lint || echo "Lint issues found - may need manual review"

      - name: Build check
        if: steps.updates.outputs.updates_available == 'true'
        run: npm run build
        env:
          SKIP_ENV_VALIDATION: 'true'
          NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: 'pk_test_placeholder'

      - name: Create Pull Request
        if: steps.updates.outputs.updates_available == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(deps): update dependencies'
          title: 'chore(deps): Weekly dependency updates'
          body: |
            ## Automated Dependency Updates

            This PR contains automated dependency updates.

            ### Changes
            - Updated npm packages to their latest compatible versions
            - Regenerated Prisma client
            - Verified build passes

            ### Checklist
            - [ ] Review changelog for breaking changes
            - [ ] Test critical functionality
            - [ ] Check for any deprecation warnings

            ---
            *This PR was automatically generated by the dependency update workflow.*
          branch: deps/weekly-update
          delete-branch: true
          labels: |
            dependencies
            automated

  security-updates:
    name: Security Updates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Run security audit
        id: audit
        run: |
          npm audit --json > audit.json || true

          # Check for vulnerabilities
          VULN_COUNT=$(cat audit.json | jq '.metadata.vulnerabilities | add // 0')
          echo "vulnerability_count=$VULN_COUNT" >> $GITHUB_OUTPUT

          if [ "$VULN_COUNT" -gt 0 ]; then
            echo "## Security Audit Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat audit.json | jq -r '.metadata.vulnerabilities | to_entries[] | select(.value > 0) | "- \(.key): \(.value)"' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Attempt automatic fix
        if: steps.audit.outputs.vulnerability_count > 0
        run: |
          npm audit fix || echo "Some vulnerabilities could not be automatically fixed"

      - name: Create security PR if fixes applied
        if: steps.audit.outputs.vulnerability_count > 0
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'fix(security): apply npm audit fixes'
          title: 'fix(security): Automated security fixes'
          body: |
            ## Automated Security Fixes

            This PR contains automated security fixes from `npm audit fix`.

            ### Important
            - Review changes carefully
            - Test critical functionality
            - Some vulnerabilities may require manual intervention

            ---
            *This PR was automatically generated by the security update workflow.*
          branch: security/audit-fixes
          delete-branch: true
          labels: |
            security
            automated
